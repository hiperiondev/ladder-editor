<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ladder PLC Editor</title>
    <style>
        :root {
            --cell-size: 60px;
            --label-width: 40px;
            --controls-height: 60px;
        }
        @media (max-width: 600px) {
            :root {
                --cell-size: 40px;
                --label-width: 30px;
                --controls-height: 50px;
            }
            #symbolValues th {
                display: none;
            }
        }
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            margin: 20px;
            overflow-x: auto;
        }
        #controls {
            margin-bottom: 20px;
        }
        #networks-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .network-wrapper {
            position: relative;
            display: block;
            margin-bottom: 20px;
        }
        .network-table {
            border-collapse: collapse;
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            margin-left: var(--label-width);
            margin-top: calc(var(--controls-height) + 20px);
            margin-bottom: 40px;
            border: 1px solid #ddd;
        }
        .network-table td {
            width: var(--cell-size);
            height: var(--cell-size);
            border: 1px solid #ddd;
            padding: 0;
            text-align: center;
            vertical-align: middle;
            cursor: pointer;
            position: relative;
            overflow: visible;
            box-sizing: border-box;
            background-color: #fff;
        }
        .network-table td:hover {
            background-color: #f5f5f5;
        }
        .network-table td svg {
            width: 100%;
            height: 100%;
            display: block;
            margin: 0 auto;
            object-fit: contain;
            preserveAspectRatio: meet;
        }
        .multi-cell-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: var(--cell-size);
        }
        .row-label, .col-label {
            font-size: 14px;
            font-weight: bold;
            color: #333;
            position: absolute;
            pointer-events: none;
        }
        .row-label {
            width: var(--label-width);
            text-align: right;
            left: 0;
            padding-right: 6px;
            top: calc(var(--controls-height) + 20px + var(--row-index) * var(--cell-size) + (var(--cell-size) / 2));
            transform: translateY(-50%);
        }
        .col-label {
            width: var(--cell-size);
            text-align: center;
            top: calc(var(--controls-height) + 20px - 3px - 14px);
            left: calc(var(--label-width) + var(--col-index) * var(--cell-size));
        }
        #symbolValues {
            margin-top: 20px;
            background-color: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 0 5px rgba(0,0,0,0.1);
        }
        #symbolValues table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        #symbolValues th, #symbolValues td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        #symbolValues th {
            background-color: #0288d1;
            color: white;
        }
        #symbolValues tr:nth-child(even) td.data {
            background-color: #fffde7;
        }
        #symbolValues tr:nth-child(odd) td.data {
            background-color: #f5f5f5;
        }
        #symbolValues td.network-id {
            background-color: #e0f7fa;
        }
        #symbolValues td.symbol {
            background-color: #e6ffe6;
        }
        #symbolMenu, #dataTypeMenu {
            position: absolute;
            background-color: #fff;
            border: 1px solid #ccc;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 1000;
            padding: 5px;
            display: none;
            min-width: 150px;
        }
        .menu-item {
            padding: 5px 10px;
            cursor: pointer;
        }
        .menu-item:hover {
            background-color: #e0e0e0;
        }
        .value-entry {
            margin-bottom: 10px;
        }
        .value-label {
            font-weight: bold;
            margin-right: 5px;
        }
        .value-pair {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }
        .value-pair select, .value-pair input, .value-pair span {
            margin-right: 5px;
            font-size: 12px;
        }
        button {
            padding: 5px 10px;
            margin-right: 5px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        .delete-button {
            background-color: #ff0000;
        }
        .delete-button:hover {
            background-color: #cc0000;
        }
        input {
            padding: 5px;
            margin-right: 10px;
            width: 60px;
        }
        .network-controls {
            position: absolute;
            top: 0;
            left: 0;
            display: flex;
            align-items: center;
            padding: 5px 0;
            z-index: 10;
        }
        .network-label {
            position: absolute;
            top: -20px;
            left: 0;
            font-weight: bold;
            width: 150px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .vertical-bar {
            position: absolute;
            z-index: 100;
        }
        @media (max-width: 600px) {
            .row-label, .col-label {
                font-size: 12px;
            }
            .row-label {
                left: 0;
                padding-right: 6px;
            }
            .col-label {
                top: calc(var(--controls-height) + 20px - 3px - 12px);
            }
            input {
                width: 50px;
            }
            .network-label {
                width: 120px;
            }
            #symbolValues table {
                font-size: 12px;
            }
            #symbolValues th, #symbolValues td {
                padding: 5px;
            }
            #symbolValues table, #symbolValues thead, #symbolValues tbody, #symbolValues th, #symbolValues td, #symbolValues tr {
                display: block;
            }
            #symbolValues thead {
                display: none;
            }
            #symbolValues tr {
                margin-bottom: 15px;
            }
            #symbolValues td {
                border: none;
                position: relative;
                padding-left: 50%;
                text-align: left;
            }
            #symbolValues td::before {
                content: attr(data-label);
                position: absolute;
                left: 6px;
                width: 45%;
                padding-right: 10px;
                white-space: nowrap;
                font-weight: bold;
            }
            #symbolValues td.data {
                word-wrap: break-word;
            }
        }
        .blinking {
            animation: backgroundBlink 1s infinite;
        }
        .blinking svg [stroke] {
            animation: strokeBlink 1s infinite;
        }
        .blinking svg text {
            animation: fillBlink 1s infinite;
        }
        @keyframes backgroundBlink {
            0% { background-color: #fff; }
            50% { background-color: #ffcccc; }
            100% { background-color: #fff; }
        }
        @keyframes strokeBlink {
            0% { stroke: green; }
            50% { stroke: red; }
            100% { stroke: green; }
        }
        @keyframes fillBlink {
            0% { fill: green; }
            50% { fill: red; }
            100% { fill: green; }
        }
        tr.blinking td {
            animation: rowBlink 1s infinite;
        }
        @keyframes rowBlink {
            0% { background-color: #fff; }
            50% { background-color: #ffcccc; }
            100% { background-color: #fff; }
        }
        td.active {
            background-color: yellow;
        }
    </style>
</head>
<body>
    <div id="controls">
        <button onclick="addNetwork()">Add Network</button>
        <button onclick="saveNetworks()">Save</button>
        <input type="file" id="loadFile" accept=".json" style="display: none;" onchange="loadNetworks(event)">
        <button onclick="initiateLoad()">Load</button>
        <button onclick="undo()">Undo</button>
        <button onclick="redo()">Redo</button>
        <div id="ws-indicator" style="display: inline-block; width: 20px; height: 20px; border-radius: 50%; background-color: red; margin-left: 10px;"></div>
    </div>
    <div id="networks-container"></div>
    <div id="symbolMenu"></div>
    <div id="dataTypeMenu"></div>
    <div id="symbolValues"></div>

    <script>
        const dataTypes = [
            "NONE", "M", "Q", "I", "Cd", "Cr", "Td", "Tr", "IW", "QW", "C", "T",
            "D", "CSTR", "REAL", "MS", "10MS", "100MS",
            "SEC", "MIN", "K"
        ];

        const symbols = {
            "NOP": {
                cells: 1,
                dataEntries: [],
                svg: `<svg viewBox="0 0 60 60"><rect x="10" y="10" width="40" height="40" fill="none" stroke="green" stroke-width="2"/><text x="30" y="25" font-size="12" text-anchor="middle" fill="green">NOP</text></svg>`,
                pins: [{ left: false, right: false }]
            },
            "CONN": {
                cells: 1,
                dataEntries: [],
                svg: `<svg viewBox="0 0 60 60"><line x1="0" y1="30" x2="60" y2="30" stroke="green" stroke-width="2"/></svg>`,
                pins: [{ left: true, right: true }]
            },
            "NEG": {
                cells: 1,
                dataEntries: [
                    {
                        name: "value1",
                        allowedTypes: ["NONE"]
                    }
                ],
                svg: `<svg viewBox="0 0 60 60"><line x1="0" y1="30" x2="10" y2="30" stroke="green" stroke-width="2"/><rect x="10" y="10" width="40" height="40" fill="none" stroke="green" stroke-width="2"/><text x="30" y="25" font-size="12" text-anchor="middle" fill="green">NEG</text><line x1="50" y1="30" x2="60" y2="30" stroke="green" stroke-width="2"/></svg>`,
                pins: [{ left: true, right: true }]
            },
            "NO": {
                cells: 1,
                dataEntries: [
                    {
                        name: "value1",
                        allowedTypes: [
                            "I",
                            "Q",
                            "D",
                            "T",
                            "C",
                            "IW",
                            "K",
                            "QW"
                        ]
                    }
                ],
                svg: `<svg viewBox="0 0 60 60"><line x1="0" y1="30" x2="20" y2="30" stroke="green" stroke-width="2"/><line x1="20" y1="20" x2="20" y2="40" stroke="green" stroke-width="2"/><line x1="40" y1="20" x2="40" y2="40" stroke="green" stroke-width="2"/><line x1="40" y1="30" x2="60" y2="30" stroke="green" stroke-width="2"/></svg>`,
                pins: [{ left: true, right: true }]
            },
            "NC": {
                cells: 1,
                dataEntries: [
                    {
                        name: "value1",
                        allowedTypes: [
                            "I",
                            "Q",
                            "D",
                            "T",
                            "C",
                            "IW",
                            "K",
                            "QW"
                        ]
                    }
                ],
                svg: `<svg viewBox="0 0 60 60"><line x1="0" y1="30" x2="20" y2="30" stroke="green" stroke-width="2"/><line x1="20" y1="20" x2="20" y2="40" stroke="green" stroke-width="2"/><line x1="40" y1="20" x2="40" y2="40" stroke="green" stroke-width="2"/><line x1="40" y1="30" x2="60" y2="30" stroke="green" stroke-width="2"/><line x1="20" y1="40" x2="40" y2="20" stroke="green" stroke-width="2"/></svg>`,
                pins: [{ left: true, right: true }]
            },
            "RE": {
                cells: 1,
                dataEntries: [
                    {
                        name: "value1",
                        allowedTypes: [
                            "I",
                            "Q",
                            "D",
                            "T",
                            "C",
                            "IW",
                            "K",
                            "QW"
                        ]
                    }
                ],
                svg: `<svg viewBox="0 0 60 60"><line x1="0" y1="30" x2="20" y2="30" stroke="green" stroke-width="2"/><line x1="20" y1="20" x2="20" y2="40" stroke="green" stroke-width="2"/><line x1="40" y1="20" x2="40" y2="40" stroke="green" stroke-width="2"/><line x1="40" y1="30" x2="60" y2="30" stroke="green" stroke-width="2"/><text x="30" y="35" font-size="12" text-anchor="middle" fill="green">P</text></svg>`,
                pins: [{ left: true, right: true }]
            },
            "FE": {
                cells: 1,
                dataEntries: [
                    {
                        name: "value1",
                        allowedTypes: [
                            "I",
                            "Q",
                            "D",
                            "T",
                            "C",
                            "IW",
                            "K",
                            "QW"
                        ]
                    }
                ],
                svg: `<svg viewBox="0 0 60 60"><line x1="0" y1="30" x2="20" y2="30" stroke="green" stroke-width="2"/><line x1="20" y1="20" x2="20" y2="40" stroke="green" stroke-width="2"/><line x1="40" y1="20" x2="40" y2="40" stroke="green" stroke-width="2"/><line x1="40" y1="30" x2="60" y2="30" stroke="green" stroke-width="2"/><text x="30" y="35" font-size="12" text-anchor="middle" fill="green">N</text></svg>`,
                pins: [{ left: true, right: true }]
            },
            "COIL": {
                cells: 1,
                dataEntries: [
                    {
                        name: "value1",
                        allowedTypes: [
                            "M",
                            "Q"
                        ]
                    }
                ],
                svg: `<svg viewBox="0 0 60 60"><line x1="0" y1="30" x2="20" y2="30" stroke="green" stroke-width="2"/><text x="20" y="35" font-size="16" fill="green">(</text><text x="35" y="35" font-size="16" fill="green">)</text><line x1="40" y1="30" x2="60" y2="30" stroke="green" stroke-width="2"/></svg>`,
                pins: [{ left: true, right: true }]
            },
            "COILL": {
                cells: 1,
                dataEntries: [
                    {
                        name: "value1",
                        allowedTypes: [
                            "M",
                            "Q"
                        ]
                    }
                ],
                svg: `<svg viewBox="0 0 60 60"><line x1="0" y1="30" x2="20" y2="30" stroke="green" stroke-width="2"/><text x="20" y="35" font-size="16" fill="green">(</text><text x="27" y="35" font-size="12" text-anchor="middle" fill="green">S</text><text x="35" y="35" font-size="16" fill="green">)</text><line x1="40" y1="30" x2="60" y2="30" stroke="green" stroke-width="2"/></svg>`,
                pins: [{ left: true, right: true }]
            },
            "COILU": {
                cells: 1,
                dataEntries: [
                    {
                        name: "value1",
                        allowedTypes: [
                            "M",
                            "Q"
                        ]
                    }
                ],
                svg: `<svg viewBox="0 0 60 60"><line x1="0" y1="30" x2="20" y2="30" stroke="green" stroke-width="2"/><text x="20" y="35" font-size="16" fill="green">(</text><text x="27" y="35" font-size="12" text-anchor="middle" fill="green">R</text><text x="35" y="35" font-size="16" fill="green">)</text><line x1="40" y1="30" x2="60" y2="30" stroke="green" stroke-width="2"/></svg>`,
                pins: [{ left: true, right: true }]
            },
            "TON": {
                cells: 2,
                dataEntries: [
                    {
                        name: "value1",
                        allowedTypes: ["T"]
                    },
                    {
                        name: "value2",
                        allowedTypes: [
                            "MS",
                            "10MS",
                            "100MS",
                            "SEC",
                            "MIN"
                        ]
                    }
                ],
                svg: `<svg viewBox="0 0 60 120"><rect x="10" y="10" width="40" height="100" fill="none" stroke="green" stroke-width="2"/><text x="30" y="25" font-size="12" text-anchor="middle" fill="green">TON</text><text x="15" y="40" font-size="10" fill="green">IN</text><line x1="0" y1="30" x2="10" y2="30" stroke="green" stroke-width="2"/><text x="35" y="40" font-size="10" fill="green">Q0</text><line x1="50" y1="30" x2="60" y2="30" stroke="green" stroke-width="2"/><text x="35" y="100" font-size="10" fill="green">Q1</text><line x1="50" y1="90" x2="60" y2="90" stroke="green" stroke-width="2"/></svg>`,
                pins: [
                    { left: true, right: true },
                    { left: false, right: true }
                ]
            },
            "TOF": {
                cells: 2,
                dataEntries: [
                    {
                        name: "value1",
                        allowedTypes: ["T"]
                    },
                    {
                        name: "value2",
                        allowedTypes: [
                            "MS",
                            "10MS",
                            "100MS",
                            "SEC",
                            "MIN"
                        ]
                    }
                ],
                svg: `<svg viewBox="0 0 60 120"><rect x="10" y="10" width="40" height="100" fill="none" stroke="green" stroke-width="2"/><text x="30" y="25" font-size="12" text-anchor="middle" fill="green">TOF</text><text x="15" y="40" font-size="10" fill="green">IN</text><line x1="0" y1="30" x2="10" y2="30" stroke="green" stroke-width="2"/><text x="35" y="40" font-size="10" fill="green">Q0</text><line x1="50" y1="30" x2="60" y2="30" stroke="green" stroke-width="2"/><text x="35" y="100" font-size="10" fill="green">Q1</text><line x1="50" y1="90" x2="60" y2="90" stroke="green" stroke-width="2"/></svg>`,
                pins: [
                    { left: true, right: true },
                    { left: false, right: true }
                ]
            },
            "TP": {
                cells: 2,
                dataEntries: [
                    {
                        name: "value1",
                        allowedTypes: ["T"]
                    },
                    {
                        name: "value2",
                        allowedTypes: [
                            "MS",
                            "10MS",
                            "100MS",
                            "SEC",
                            "MIN"
                        ]
                    }
                ],
                svg: `<svg viewBox="0 0 60 120"><rect x="10" y="10" width="40" height="100" fill="none" stroke="green" stroke-width="2"/><text x="30" y="25" font-size="12" text-anchor="middle" fill="green">TP</text><text x="15" y="40" font-size="10" fill="green">IN</text><line x1="0" y1="30" x2="10" y2="30" stroke="green" stroke-width="2"/><text x="35" y="40" font-size="10" fill="green">Q0</text><line x1="50" y1="30" x2="60" y2="30" stroke="green" stroke-width="2"/><text x="35" y="100" font-size="10" fill="green">Q1</text><line x1="50" y1="90" x2="60" y2="90" stroke="green" stroke-width="2"/></svg>`,
                pins: [
                    { left: true, right: true },
                    { left: false, right: true }
                ]
            },
            "CTU": {
                cells: 2,
                dataEntries: [
                    {
                        name: "value1",
                        allowedTypes: ["C"]
                    },
                    {
                        name: "value2",
                        allowedTypes: ["NONE"]
                    }
                ],
                svg: `<svg viewBox="0 0 60 120"><rect x="10" y="10" width="40" height="100" fill="none" stroke="green" stroke-width="2"/><text x="30" y="25" font-size="12" text-anchor="middle" fill="green">CTU</text><text x="15" y="40" font-size="10" fill="green">CU</text><line x1="0" y1="30" x2="10" y2="30" stroke="green" stroke-width="2"/><text x="15" y="100" font-size="10" fill="green">R</text><line x1="0" y1="90" x2="10" y2="90" stroke="green" stroke-width="2"/><text x="35" y="40" font-size="10" fill="green">Q0</text><line x1="50" y1="30" x2="60" y2="30" stroke="green" stroke-width="2"/><text x="35" y="100" font-size="10" fill="green">Q1</text><line x1="50" y1="90" x2="60" y2="90" stroke="green" stroke-width="2"/></svg>`,
                pins: [
                    { left: true, right: true },
                    { left: true, right: true }
                ]
            },
            "CTD": {
                cells: 2,
                dataEntries: [
                    {
                        name: "value1 Jubal",
                        allowedTypes: ["C"]
                    },
                    {
                        name: "value2",
                        allowedTypes: ["NONE"]
                    }
                ],
                svg: `<svg viewBox="0 0 60 120"><rect x="10" y="10" width="40" height="100" fill="none" stroke="green" stroke-width="2"/><text x="30" y="25" font-size="12" text-anchor="middle" fill="green">CTD</text><text x="15" y="40" font-size="10" fill="green">CD</text><line x1="0" y1="30" x2="10" y2="30" stroke="green" stroke-width="2"/><text x="15" y="100" font-size="10" fill="green">R</text><line x1="0" y1="90" x2="10" y2="90" stroke="green" stroke-width="2"/><text x="35" y="40" font-size="10" fill="green">Q0</text><line x1="50" y1="30" x2="60" y2="30" stroke="green" stroke-width="2"/><text x="35" y="100" font-size="10" fill="green">Q1</text><line x1="50" y1="90" x2="60" y2="90" stroke="green" stroke-width="2"/></svg>`,
                pins: [
                    { left: true, right: true },
                    { left: true, right: true }
                ]
            },
            "MOVE": {
                cells: 1,
                dataEntries: [
                    {
                        name: "value1",
                        allowedTypes: [
                            "D",
                            "T",
                            "C",
                            "IW",
                            "K",
                            "QW"
                        ]
                    },
                    {
                        name: "value2",
                        allowedTypes: [
                            "D",
                            "T",
                            "C",
                            "IW",
                            "K",
                            "QW"
                        ]
                    }
                ],
                svg: `<svg viewBox="0 0 60 60"><line x1="0" y1="30" x2="10" y2="30" stroke="green" stroke-width="2"/><rect x="10" y="10" width="40" height="40" fill="none" stroke="green" stroke-width="2"/><text x="30" y="25" font-size="12" text-anchor="middle" fill="green">MOVE</text><line x1="50" y1="30" x2="60" y2="30" stroke="green" stroke-width="2"/></svg>`,
                pins: [{ left: true, right: true }]
            },
            "SUB": {
                cells: 3,
                dataEntries: [
                    {
                        name: "value1",
                        allowedTypes: [
                            "D",
                            "T",
                            "C",
                            "IW",
                            "K",
                            "QW"
                        ]
                    },
                    {
                        name: "value2",
                        allowedTypes: [
                            "D",
                            "T",
                            "C",
                            "IW",
                            "K",
                            "QW"
                        ]
                    },
                    {
                        name: "value3",
                        allowedTypes: [
                            "D",
                            "T",
                            "C",
                            "IW",
                            "K",
                            "QW"
                        ]
                    }
                ],
                svg: `<svg viewBox="0 0 60 180"><rect x="10" y="10" width="40" height="160" fill="none" stroke="green" stroke-width="2"/><text x="30" y="25" font-size.construct:12" text-anchor="middle" fill="green">SUB</text><text x="15" y="40" font-size="10" fill="green">IN</text><line x1="0" y1="30" x2="10" y2="30" stroke="green" stroke-width="2"/><text x="35" y="40" font-size="10" fill="green">Q0</text><line x1="50" y1="30" x2="60" y2="30" stroke="green" stroke-width="2"/><text x="35" y="100" font-size="10" fill="green">Q1</text><line x1="50" y1="90" x2="60" y2="90" stroke="green" stroke-width="2"/><text x="35" y="160" font-size="10" fill="green">Q2</text><line x1="50" y1="150" x2="60" y2="150" stroke="green" stroke-width="2"/></svg>`,
                pins: [
                    { left: true, right: true },
                    { left: false, right: true },
                    { left: false, right: true }
                ]
            },
            "ADD": {
                cells: 1,
                dataEntries: [
                    {
                        name: "value1",
                        allowedTypes: [
                            "D",
                            "T",
                            "C",
                            "IW",
                            "K",
                            "QW"
                        ]
                    },
                    {
                        name: "value2",
                        allowedTypes: [
                            "D",
                            "T",
                            "C",
                            "IW",
                            "K",
                            "QW"
                        ]
                    },
                    {
                        name: "value3",
                        allowedTypes: [
                            "D",
                            "T",
                            "C",
                            "IW",
                            "K",
                            "QW"
                        ]
                    }
                ],
                svg: `<svg viewBox="0 0 60 60"><line x1="0" y1="30" x2="10" y2="30" stroke="green" stroke-width="2"/><rect x="10" y="10" width="40" height="40" fill="none" stroke="green" stroke-width="2"/><text x="30" y="25" font-size="12" text-anchor="middle" fill="green">ADD</text><line x1="50" y1="30" x2="60" y2="30" stroke="green" stroke-width="2"/></svg>`,
                pins: [{ left: true, right: true }]
            },
            "MUL": {
                cells: 1,
                dataEntries: [
                    {
                        name: "value1",
                        allowedTypes: [
                            "D",
                            "T",
                            "C",
                            "IW",
                            "K",
                            "QW"
                        ]
                    },
                    {
                        name: "value2",
                        allowedTypes: [
                            "D",
                            "T",
                            "C",
                            "IW",
                            "K",
                            "QW"
                        ]
                    },
                    {
                        name: "value3",
                        allowedTypes: [
                            "D",
                            "T",
                            "C",
                            "IW",
                            "K",
                            "QW"
                        ]
                    }
                ],
                svg: `<svg viewBox="0 0 60 60"><line x1="0" y1="30" x2="10" y2="30" stroke="green" stroke-width="2"/><rect x="10" y="10" width="40" height="40" fill="none" stroke="green" stroke-width="2"/><text x="30" y="25" font-size="12" text-anchor="middle" fill="green">MUL</text><line x1="50" y1="30" x2="60" y2="30" stroke="green" stroke-width="2"/></svg>`,
                pins: [{ left: true, right: true }]
            },
            "DIV": {
                cells: 2,
                dataEntries: [
                    {
                        name: "value1",
                        allowedTypes: [
                            "D",
                            "T",
                            "C",
                            "IW",
                            "K",
                            "QW"
                        ]
                    },
                    {
                        name: "value2",
                        allowedTypes: [
                            "D",
                            "T",
                            "C",
                            "IW",
                            "K",
                            "QW"
                        ]
                    },
                    {
                        name: "value3",
                        allowedTypes: [
                            "D",
                            "T",
                            "C",
                            "IW",
                            "K",
                            "QW"
                        ]
                    }
                ],
                svg: `<svg viewBox="0 0 60 120"><rect x="10" y="10" width="40" height="100" fill="none" stroke="green" stroke-width="2"/><text x="30" y="25" font-size="12" text-anchor="middle" fill="green">DIV</text><text x="15" y="40" font-size="10" fill="green">IN</text><line x1="0" y1="30" x2="10" y2="30" stroke="green" stroke-width="2"/><text x="35" y="40" font-size="10" fill="green">Q0</text><line x1="50" y1="30" x2="60" y2="30" stroke="green" stroke-width="2"/><text x="35" y="100" font-size="10" fill="green">Q1</text><line x1="50" y1="90" x2="60" y2="90" stroke="green" stroke-width="2"/></svg>`,
                pins: [
                    { left: true, right: true },
                    { left: false, right: true }
                ]
            },
            "MOD": {
                cells: 1,
                dataEntries: [
                    {
                        name: "value1",
                        allowedTypes: [
                            "D",
                            "T",
                            "C",
                            "IW",
                            "K",
                            "QW"
                        ]
                    },
                    {
                        name: "value2",
                        allowedTypes: [
                            "D",
                            "T",
                            "C",
                            "IW",
                            "K",
                            "QW"
                        ]
                    },
                    {
                        name: "value3",
                        allowedTypes: [
                            "D",
                            "T",
                            "C",
                            "IW",
                            "K",
                            "QW"
                        ]
                    }
                ],
                svg: `<svg viewBox="0 0 60 60"><line x1="0" y1="30" x2="10" y2="30" stroke="green" stroke-width="2"/><rect x="10" y="10" width="40" height="40" fill="none" stroke="green" stroke-width="2"/><text x="30" y="25" font-size="12" text-anchor="middle" fill="green">MOD</text><line x1="50" y1="30" x2="60" y2="30" stroke="green" stroke-width="2"/></svg>`,
                pins: [{ left: true, right: true }]
            },
            "SHL": {
                cells: 1,
                dataEntries: [
                    {
                        name: "value1",
                        allowedTypes: [
                            "D",
                            "T",
                            "C",
                            "IW",
                            "K",
                            "QW"
                        ]
                    },
                    {
                        name: "value2",
                        allowedTypes: [
                            "D",
                            "T",
                            "C",
                            "IW",
                            "K",
                            "QW"
                        ]
                    }
                ],
                svg: `<svg viewBox="0 0 60 60"><line x1="0" y1="30" x2="10" y2="30" stroke="green" stroke-width="2"/><rect x="10" y="10" width="40" height="40" fill="none" stroke="green" stroke-width="2"/><text x="30" y="25" font-size="12" text-anchor="middle" fill="green">SHL</text><line x1="50" y1="30" x2="60" y2="30" stroke="green" stroke-width="2"/></svg>`,
                pins: [{ left: true, right: true }]
            },
            "SHR": {
                cells: 1,
                dataEntries: [
                    {
                        name: "value1",
                        allowedTypes: [
                            "D",
                            "T",
                            "C",
                            "IW",
                            "K",
                            "QW"
                        ]
                    },
                    {
                        name: "value2",
                        allowedTypes: [
                            "D",
                            "T",
                            "C",
                            "IW",
                            "K",
                            "QW"
                        ]
                    }
                ],
                svg: `<svg viewBox="0 0 60 60"><line x1="0" y1="30" x2="10" y2="30" stroke="green" stroke-width="2"/><rect x="10" y="10" width="40" height="40" fill="none" stroke="green" stroke-width="2"/><text x="30" y="25" font-size="12" text-anchor="middle" fill="green">SHR</text><line x1="50" y1="30" x2="60" y2="30" stroke="green" stroke-width="2"/></svg>`,
                pins: [{ left: true, right: true }]
            },
            "ROL": {
                cells: 1,
                dataEntries: [
                    {
                        name: "value1",
                        allowedTypes: [
                            "D",
                            "T",
                            "C",
                            "IW",
                            "K",
                            "QW"
                        ]
                    },
                    {
                        name: "value2",
                        allowedTypes: [
                            "D",
                            "T",
                            "C",
                            "IW",
                            "K",
                            "QW"
                        ]
                    }
                ],
                svg: `<svg viewBox="0 0 60 60"><line x1="0" y1="30" x2="10" y2="30" stroke="green" stroke-width="2"/><rect x="10" y="10" width="40" height="40" fill="none" stroke="green" stroke-width="2"/><text x="30" y="25" font-size="12" text-anchor="middle" fill="green">ROL</text><line x1="50" y1="30" x2="60" y2="30" stroke="green" stroke-width="2"/></svg>`,
                pins: [{ left: true, right: true }]
            },
            "ROR": {
                cells: 1,
                dataEntries: [
                    {
                        name: "value1",
                        allowedTypes: [
                            "D",
                            "T",
                            "C",
                            "IW",
                            "K",
                            "QW"
                        ]
                    },
                    {
                        name: "value2",
                        allowedTypes: [
                            "D",
                            "T",
                            "C",
                            "IW",
                            "K",
                            "QW"
                        ]
                    }
                ],
                svg: `<svg viewBox="0 0 60 60"><line x1="0" y1="30" x2="10" y2="30" stroke="green" stroke-width="2"/><rect x="10" y="10" width="40" height="40" fill="none" stroke="green" stroke-width="2"/><text x="30" y="25" font-size="12" text-anchor="middle" fill="green">ROR</text><line x1="50" y1="30" x2="60" y2="30" stroke="green" stroke-width="2"/></svg>`,
                pins: [{ left: true, right: true }]
            },
            "AND": {
                cells: 1,
                dataEntries: [
                    {
                        name: "value1",
                        allowedTypes: [
                            "D",
                            "T",
                            "C",
                            "IW",
                            "K",
                            "QW"
                        ]
                    },
                    {
                        name: "value2",
                        allowedTypes: [
                            "D",
                            "T",
                            "C",
                            "IW",
                            "K",
                            "QW"
                        ]
                    },
                    {
                        name: "value3",
                        allowedTypes: [
                            "D",
                            "T",
                            "C",
                            "IW",
                            "K",
                            "QW"
                        ]
                    }
                ],
                svg: `<svg viewBox="0 0 60 60"><line x1="0" y1="30" x2="10" y2="30" stroke="green" stroke-width="2"/><rect x="10" y="10" width="40" height="40" fill="none" stroke="green" stroke-width="2"/><text x="30" y="25" font-size="12" text-anchor="middle" fill="green">AND</text><line x1="50" y1="30" x2="60" y2="30" stroke="green" stroke-width="2"/></svg>`,
                pins: [{ left: true, right: true }]
            },
            "OR": {
                cells: 1,
                dataEntries: [
                    {
                        name: "value1",
                        allowedTypes: [
                            "D",
                            "T",
                            "C",
                            "IW",
                            "K",
                            "QW"
                        ]
                    },
                    {
                        name: "value2",
                        allowedTypes: [
                            "D",
                            "T",
                            "C",
                            "IW",
                            "K",
                            "QW"
                        ]
                    },
                    {
                        name: "value3",
                        allowedTypes: [
                            "D",
                            "T",
                            "C",
                            "IW",
                            "K",
                            "QW"
                        ]
                    }
                ],
                svg: `<svg viewBox="0 0 60 60"><line x1="0" y1="30" x2="10" y2="30" stroke="green" stroke-width="2"/><rect x="10" y="10" width="40" height="40" fill="none" stroke="green" stroke-width="2"/><text x="30" y="25" font-size="12" text-anchor="middle" fill="green">OR</text><line x1="50" y1="30" x2="60" y2="30" stroke="green" stroke-width="2"/></svg>`,
                pins: [{ left: true, right: true }]
            },
            "XOR": {
                cells: 1,
                dataEntries: [
                    {
                        name: "value1",
                        allowedTypes: [
                            "D",
                            "T",
                            "C",
                            "IW",
                            "K",
                            "QW"
                        ]
                    },
                    {
                        name: "value2",
                        allowedTypes: [
                            "D",
                            "T",
                            "C",
                            "IW",
                            "K",
                            "QW"
                        ]
                    },
                    {
                        name: "value3",
                        allowedTypes: [
                            "D",
                            "T",
                            "C",
                            "IW",
                            "K",
                            "QW"
                        ]
                    }
                ],
                svg: `<svg viewBox="0 0 60 60"><line x1="0" y1="30" x2="10" y2="30" stroke="green" stroke-width="2"/><rect x="10" y="10" width="40" height="40" fill="none" stroke="green" stroke-width="2"/><text x="30" y="25" font-size="12" text-anchor="middle" fill="green">XOR</text><line x1="50" y1="30" x2="60" y2="30" stroke="green" stroke-width="2"/></svg>`,
                pins: [{ left: true, right: true }]
            },
            "NOT": {
                cells: 1,
                dataEntries: [
                    {
                        name: "value1",
                        allowedTypes: [
                            "D",
                            "T",
                            "C",
                            "IW",
                            "K",
                            "QW"
                        ]
                    },
                    {
                        name: "value2",
                        allowedTypes: [
                            "D",
                            "T",
                            "C",
                            "IW",
                            "K",
                            "QW"
                        ]
                    }
                ],
                svg: `<svg viewBox="0 0 60 60"><line x1="0" y1="30" x2="10" y2="30" stroke="green" stroke-width="2"/><rect x="10" y="10" width="40" height="40" fill="none" stroke="green" stroke-width="2"/><text x="30" y="25" font-size="12" text-anchor="middle" fill="green">NOT</text><line x1="50" y1="30" x2="60" y2="30" stroke="green" stroke-width="2"/></svg>`,
                pins: [{ left: true, right: true }]
            },
            "EQ": {
                cells: 1,
                dataEntries: [
                    {
                        name: "value1",
                        allowedTypes: [
                            "D",
                            "T",
                            "C",
                            "IW",
                            "K",
                            "QW"
                        ]
                    },
                    {
                        name: "value2",
                        allowedTypes: [
                            "D",
                            "T",
                            "C",
                            "IW",
                            "K",
                            "QW"
                        ]
                    }
                ],
                svg: `<svg viewBox="0 0 60 60"><line x1="0" y1="30" x2="10" y2="30" stroke="green" stroke-width="2"/><rect x="10" y="10" width="40" height="40" fill="none" stroke="green" stroke-width="2"/><text x="30" y="25" font-size="12" text-anchor="middle" fill="green">EQ</text><line x1="50" y1="30" x2="60" y2="30" stroke="green" stroke-width="2"/></svg>`,
                pins: [{ left: true, right: true }]
            },
            "GT": {
                cells: 1,
                dataEntries: [
                    {
                        name: "value1",
                        allowedTypes: [
                            "D",
                            "T",
                            "C",
                            "IW",
                            "K",
                            "QW"
                        ]
                    },
                    {
                        name: "value2",
                        allowedTypes: [
                            "D",
                            "T",
                            "C",
                            "IW",
                            "K",
                            "QW"
                        ]
                    }
                ],
                svg: `<svg viewBox="0 0 60 60"><line x1="0" y1="30" x2="10" y2="30" stroke="green" stroke-width="2"/><rect x="10" y="10" width="40" height="40" fill="none" stroke="green" stroke-width="2"/><text x="30" y="25" font-size="12" text-anchor="middle" fill="green">GT</text><line x1="50" y1="30" x2="60" y2="30" stroke="green" stroke-width="2"/></svg>`,
                pins: [{ left: true, right: true }]
            },
            "GE": {
                cells: 1,
                dataEntries: [
                    {
                        name: "value1",
                        allowedTypes: [
                            "D",
                            "T",
                            "C",
                            "IW",
                            "K",
                            "QW"
                        ]
                    },
                    {
                        name: "value2",
                        allowedTypes: [
                            "D",
                            "T",
                            "C",
                            "IW",
                            "K",
                            "QW"
                        ]
                    }
                ],
                svg: `<svg viewBox="0 0 60 60"><line x1="0" y1="30" x2="10" y2="30" stroke="green" stroke-width="2"/><rect x="10" y="10" width="40" height="40" fill="none" stroke="green" stroke-width="2"/><text x="30" y="25" font-size="12" text-anchor="middle" fill="green">GE</text><line x1="50" y1="30" x2="60" y2="30" stroke="green" stroke-width="2"/></svg>`,
                pins: [{ left: true, right: true }]
            },
            "LT": {
                cells: 1,
                dataEntries: [
                    {
                        name: "value1",
                        allowedTypes: [
                            "D",
                            "T",
                            "C",
                            "IW",
                            "K",
                            "QW"
                        ]
                    },
                    {
                        name: "value2",
                        allowedTypes: [
                            "D",
                            "T",
                            "C",
                            "IW",
                            "K",
                            "QW"
                        ]
                    }
                ],
                svg: `<svg viewBox="0 0 60 60"><line x1="0" y1="30" x2="10" y2="30" stroke="green" stroke-width="2"/><rect x="10" y="10" width="40" height="40" fill="none" stroke="green" stroke-width="2"/><text x="30" y="25" font-size="12" text-anchor="middle" fill="green">LT</text><line x1="50" y1="30" x2="60" y2="30" stroke="green" stroke-width="2"/></svg>`,
                pins: [{ left: true, right: true }]
            },
            "LE": {
                cells: 1,
                dataEntries: [
                    {
                        name: "value1",
                        allowedTypes: [
                            "D",
                            "T",
                            "C",
                            "IW",
                            "K",
                            "QW"
                        ]
                    },
                    {
                        name: "value2",
                        allowedTypes: [
                            "D",
                            "T",
                            "C",
                            "IW",
                            "K",
                            "QW"
                        ]
                    }
                ],
                svg: `<svg viewBox="0 0 60 60"><line x1="0" y1="30" x2="10" y2="30" stroke="green" stroke-width="2"/><rect x="10" y="10" width="40" height="40" fill="none" stroke="green" stroke-width="2"/><text x="30" y="25" font-size="12" text-anchor="middle" fill="green">LE</text><line x1="50" y1="30" x2="60" y2="30" stroke="green" stroke-width="2"/></svg>`,
                pins: [{ left: true, right: true }]
            },
            "NE": {
                cells: 1,
                dataEntries: [
                    {
                        name: "value1",
                        allowedTypes: [
                            "D",
                            "T",
                            "C",
                            "IW",
                            "K",
                            "QW"
                        ]
                    },
                    {
                        name: "value2",
                        allowedTypes: [
                            "D",
                            "T",
                            "C",
                            "IW",
                            "K",
                            "QW"
                        ]
                    }
                ],
                svg: `<svg viewBox="0 0 60 60"><line x1="0" y1="30" x2="10" y2="30" stroke="green" stroke-width="2"/><rect x="10" y="10" width="40" height="40" fill="none" stroke="green" stroke-width="2"/><text x="30" y="25" font-size="12" text-anchor="middle" fill="green">NE</text><line x1="50" y1="30" x2="60" y2="30" stroke="green" stroke-width="2"/></svg>`,
                pins: [{ left: true, right: true }]
            },
            "TMOVE": {
                cells: 1,
                dataEntries: [
                    {
                        name: "value1",
                        allowedTypes: [
                            "D",
                            "T",
                            "C",
                            "IW",
                            "K",
                            "QW"
                        ]
                    },
                    {
                        name: "value2",
                        allowedTypes: [
                            "D",
                            "T",
                            "C",
                            "IW",
                            "K",
                            "QW"
                        ]
                    },
                    {
                        name: "value3",
                        allowedTypes: [
                            "D",
                            "T",
                            "C",
                            "IW",
                            "K",
                            "QW"
                        ]
                    }
                ],
                svg: `<svg viewBox="0 0 60 60"><line x1="0" y1="30" x2="10" y2="30" stroke="green" stroke-width="2"/><rect x="10" y="10" width="40" height="40" fill="none" stroke="green" stroke-width="2"/><text x="30" y="25" font-size="12" text-anchor="middle" fill="green">TMOVE</text><line x1="50" y1="30" x2="60" y2="30" stroke="green" stroke-width="2"/></svg>`,
                pins: [{ left: true, right: true }]
            }
        };

        function isValidUInt32(str) {
            const num = parseInt(str, 10);
            return /^\d+$/.test(str) && !isNaN(num) && num >= 0 && num <= 4294967295;
        }

        function isValidQorI(value) {
            const parts = value.split('.');
            if (parts.length < 1 || parts.length > 3) return false;
            return parts.every(part => isValidUInt32(part));
        }

        function isValidReal(value) {
            return /^[-+]?(\d+\.?\d*|\.\d+)([eE][-+]?\d+)?$/.test(value);
        }

        function isValidCSTR(value) {
            return true;
        }

        function validateValue(type, value) {
            switch (type) {
                case "NONE":
                case "M":
                case "Cd":
                case "Cr":
                case "Td":
                case "Tr":
                case "IW":
                case "QW":
                case "C":
                case "T":
                case "D":
                case "MS":
                case "10MS":
                case "100MS":
                case "SEC":
                case "MIN":
                case "K":
                    return isValidUInt32(value);
                case "Q":
                case "I":
                    return isValidQorI(value);
                case "CSTR":
                    return isValidCSTR(value);
                case "REAL":
                    return isValidReal(value);
                default:
                    return false;
            }
        }

        const MAX_ROWS = 100;
        const MAX_COLS = 100;
        const MAX_NETWORKS = 10;

        const coilSymbols = ["COIL", "COILL", "COILU"];

        let networks = [];
        let networkCounter = 0;
        let history = [];
        let historyIndex = -1;
        let currentMenu = null;

        class Network {
            constructor(rows, cols, id = null) {
                this.id = id !== null ? id : networkCounter++;
                this.rows = rows;
                this.cols = cols;
                this.networkData = Array(rows).fill().map(() => Array(cols).fill().map(() => ({
                    symbol: "NOP",
                    bar: false,
                    data: []
                })));
                this.createNetworkElement();
            }

            createNetworkElement() {
                const container = document.getElementById('networks-container');
                const wrapper = document.createElement('div');
                wrapper.className = 'network-wrapper';
                wrapper.id = `network-container-${this.id}`;

                const label = document.createElement('div');
                label.className = 'network-label';
                label.textContent = `Network ${this.id}`;

                const controls = document.createElement('div');
                controls.className = 'network-controls';

                const rowsLabel = document.createElement('label');
                rowsLabel.textContent = 'Rows: ';
                const rowsInput = document.createElement('input');
                rowsInput.type = 'number';
                rowsInput.id = `rows-${this.id}`;
                rowsInput.value = this.rows;
                rowsInput.min = '1';
                rowsLabel.appendChild(rowsInput);

                const colsLabel = document.createElement('label');
                colsLabel.textContent = 'Cols: ';
                const colsInput = document.createElement('input');
                colsInput.type = 'number';
                colsInput.id = `cols-${this.id}`;
                colsInput.value = this.cols;
                colsInput.min = '1';
                colsLabel.appendChild(colsInput);

                const resizeButton = document.createElement('button');
                resizeButton.textContent = 'Resize';
                resizeButton.onclick = () => resizeNetwork(this.id);
                const deleteButton = document.createElement('button');
                deleteButton.className = 'delete-button';
                deleteButton.textContent = 'Delete';
                deleteButton.onclick = () => deleteOrClearNetwork(this.id);

                controls.appendChild(rowsLabel);
                controls.appendChild(colsLabel);
                controls.appendChild(resizeButton);
                controls.appendChild(deleteButton);

                const table = document.createElement('table');
                table.id = `network-${this.id}`;
                table.className = 'network-table';

                wrapper.appendChild(label);
                wrapper.appendChild(controls);
                wrapper.appendChild(table);
                container.appendChild(wrapper);
            }

            clear() {
                this.networkData = Array(this.rows).fill().map(() => Array(this.cols).fill().map(() => ({
                    symbol: "NOP",
                    bar: false,
                    data: []
                })));
                this.renderNetwork();
                renderSymbolValues();
            }

            resize(newRows, newCols) {
                const oldRows = this.rows;
                const oldCols = this.cols;
                let truncateWarning = false;

                for (let i = 0; i < oldRows; i++) {
                    for (let j = 0; j < oldCols; j++) {
                        const cell = this.networkData[i][j];
                        if (cell.symbol !== "NOP" && cell.symbol !== "occupied") {
                            const symbol = symbols[cell.symbol];
                            if (i + symbol.cells > newRows || j >= newCols) {
                                truncateWarning = true;
                            }
                        }
                    }
                }

                if (truncateWarning) {
                    showToast("Warning: Some symbols may be removed due to smaller dimensions.");
                }

                this.rows = newRows;
                this.cols = newCols;

                const newNetworkData = Array(newRows).fill().map(() => Array(newCols).fill().map(() => ({
                    symbol: "NOP",
                    bar: false,
                    data: []
                })));

                for (let i = 0; i < Math.min(oldRows, newRows); i++) {
                    for (let j = 0; j < Math.min(oldCols, newCols); j++) {
                        const cell = this.networkData[i][j];
                        if (cell.symbol !== "NOP" && cell.symbol !== "occupied") {
                            const symbol = symbols[cell.symbol];
                            if (i + symbol.cells <= newRows) {
                                newNetworkData[i][j] = { ...cell };
                                for (let k = 1; k < symbol.cells && i + k < newRows; k++) {
                                    newNetworkData[i + k][j] = {
                                        symbol: "occupied",
                                        bar: false,
                                        data: []
                                    };
                                }
                            }
                        } else {
                            newNetworkData[i][j] = { ...cell };
                        }
                    }
                }

                this.networkData = newNetworkData;
                document.getElementById(`rows-${this.id}`).value = newRows;
                document.getElementById(`cols-${this.id}`).value = newCols;
                this.renderNetwork();
                renderSymbolValues();
            }

            renderNetwork() {
                const network = document.getElementById(`network-${this.id}`);
                const networkContainer = document.getElementById(`network-container-${this.id}`);
                if (!network || !networkContainer) {
                    console.error(`Network ${this.id} or container not found`);
                    return;
                }
                network.innerHTML = '';

                document.querySelectorAll(`#network-container-${this.id} .row-label, #network-container-${this.id} .col-label, #network-container-${this.id} .vertical-bar`).forEach(el => el.remove());

                const cellSize = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--cell-size')) || 60;
                const labelWidth = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--label-width')) || 40;
                const controlsHeight = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--controls-height')) || 60;

                for (let j = 0; j < this.cols; j++) {
                    const colLabel = document.createElement('div');
                    colLabel.className = 'col-label';
                    colLabel.textContent = j;
                    colLabel.style.setProperty('--col-index', j);
                    networkContainer.appendChild(colLabel);
                }

                for (let i = 0; i < this.rows; i++) {
                    const tr = document.createElement('tr');
                    const rowLabel = document.createElement('div');
                    rowLabel.className = 'row-label';
                    rowLabel.textContent = i;
                    rowLabel.style.setProperty('--row-index', i);
                    networkContainer.appendChild(rowLabel);

                    for (let j = 0; j < this.cols; j++) {
                        if (this.networkData[i][j].symbol === "occupied") continue;

                        const td = document.createElement('td');
                        td.dataset.row = i;
                        td.dataset.col = j;
                        td.dataset.networkId = this.id;

                        if (this.networkData[i][j].symbol !== "NOP") {
                            const symbol = symbols[this.networkData[i][j].symbol];
                            try {
                                const svgContainer = document.createElement('div');
                                svgContainer.innerHTML = symbol.svg;
                                const svgElement = svgContainer.querySelector('svg');
                                if (svgElement) {
                                    td.rowSpan = symbol.cells;
                                    svgElement.style.width = `${cellSize}px`;
                                    svgElement.style.height = `${cellSize * symbol.cells}px`;
                                    svgElement.setAttribute('preserveAspectRatio', 'xMidYMid meet');
                                    if (symbol.cells > 1) {
                                        svgElement.classList.add('multi-cell-svg');
                                        td.style.position = 'relative';
                                    }
                                    td.appendChild(svgElement);
                                    for (let k = 1; k < symbol.cells && i + k < this.rows; k++) {
                                        this.networkData[i + k][j].symbol = "occupied";
                                    }
                                } else {
                                    td.innerHTML = '<div style="color: red; font-size: 10px;">Invalid Symbol</div>';
                                    console.error(`Failed to parse SVG for symbol ${this.networkData[i][j].symbol}`);
                                }
                            } catch (e) {
                                console.error(`Error rendering symbol ${this.networkData[i][j].symbol}:`, e);
                            }
                        }

                        td.addEventListener('click', showSymbolMenu);
                        td.addEventListener('contextmenu', showDataTypeMenu);
                        tr.appendChild(td);
                    }
                    network.appendChild(tr);
                }

                for (let i = 1; i < this.rows; i++) {
                    for (let j = 0; j < this.cols - 1; j++) {
                        if (this.networkData[i][j].bar && this.networkData[i][j].symbol !== 'occupied') {
                            try {
                                const barDiv = document.createElement('div');
                                barDiv.className = 'vertical-bar';
                                const barSvg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                                barSvg.setAttribute('width', '2');
                                barSvg.setAttribute('height', cellSize.toString());
                                barSvg.setAttribute('viewBox', `0 0 2 ${cellSize}`);
                                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                                line.setAttribute('x1', '1');
                                line.setAttribute('y1', '0');
                                line.setAttribute('x2', '1');
                                line.setAttribute('y2', cellSize.toString());
                                line.setAttribute('stroke', 'green');
                                line.setAttribute('stroke-width', '2');
                                barSvg.appendChild(line);
                                barDiv.appendChild(barSvg);
                                barDiv.style.left = `${labelWidth + (j + 1) * cellSize}px`;
                                barDiv.style.top = `${controlsHeight + 20 + (i - 1) * cellSize + cellSize / 2}px`;
                                networkContainer.appendChild(barDiv);
                            } catch (e) {
                                console.error(`Error rendering bar at (${i}, ${j}):`, e);
                            }
                        }
                    }
                }
            }
        }

        function renderSymbolValues() {
            const symbolValuesDiv = document.getElementById('symbolValues');
            let html = '<h3>Symbol Values</h3>';
            html += '<table>';
            html += '<tr><th>Network ID</th><th>Row</th><th>Column</th><th>Symbol</th><th>Data</th></tr>';

            let rowIndex = 0;
            networks.forEach(network => {
                for (let i = 0; i < network.rows; i++) {
                    for (let j = 0; j < network.cols; j++) {
                        const cell = network.networkData[i][j];
                        if (cell.symbol !== "NOP" && cell.symbol !== 'occupied' && cell.data.length > 0) {
                            const dataStr = cell.data.map(d => `${d.name}: ${d.type} ${d.value}`).join(', ');
                            html += `<tr class="symbol-row">
                                <td data-label="Network ID" class="network-id">${network.id}</td>
                                <td data-label="Row">${i}</td>
                                <td data-label="Column">${j}</td>
                                <td data-label="Symbol" class="symbol">${cell.symbol}</td>
                                <td data-label="Data" class="data">${dataStr}</td>
                            </tr>`;
                            rowIndex++;
                        }
                    }
                }
            });

            html += '</table>';

            if (rowIndex === 0) {
                html += '<p>No values assigned.</p>';
            }

            symbolValuesDiv.innerHTML = html;
        }

        function addNetwork() {
            const newNetwork = new Network(8, 8);
            networks.push(newNetwork);
            newNetwork.renderNetwork();
            renderSymbolValues();
            saveToHistory();
        }

        function resizeNetwork(id) {
            const network = networks.find(n => n.id === id);
            if (!network) return;
            const rowsInput = document.getElementById(`rows-${id}`);
            const colsInput = document.getElementById(`cols-${id}`);
            const newRows = parseInt(rowsInput.value);
            const newCols = parseInt(colsInput.value);
            if (isNaN(newRows) || isNaN(newCols) || newRows < 1 || newCols < 1) {
                showToast("Rows and columns must be positive numbers.");
                return;
            }
            if (newRows > MAX_ROWS || newCols > MAX_COLS) {
                showToast(`Cannot resize: exceeds maximum limits (rows <= ${MAX_ROWS}, cols <= ${MAX_COLS}).`);
                return;
            }
            network.resize(newRows, newCols);
            saveToHistory();
        }

        function deleteOrClearNetwork(id) {
            const network = networks.find(n => n.id === id);
            if (!network) return;

            if (networks.length === 1) {
                network.clear();
                showToast("Network cleared. At least one network must remain.");
                saveToHistory();
            } else {
                const indexToDelete = networks.findIndex(n => n.id === id);
                const containerToRemove = document.getElementById(`network-container-${id}`);
                if (containerToRemove) containerToRemove.remove();
                networks.splice(indexToDelete, 1);
                document.getElementById('networks-container').innerHTML = '';
                networks.forEach((network, newIndex) => {
                    network.id = newIndex;
                    network.createNetworkElement();
                    network.renderNetwork();
                });
                networkCounter = networks.length;
                renderSymbolValues();
                saveToHistory();
            }
        }

        function closeAllMenus() {
            document.getElementById('symbolMenu').style.display = 'none';
            document.getElementById('dataTypeMenu').style.display = 'none';
            currentMenu = null;
        }

        function showSymbolMenu(event) {
            event.preventDefault();
            event.stopPropagation();
            closeAllMenus();
            const td = event.currentTarget;
            const row = parseInt(td.dataset.row);
            const col = parseInt(td.dataset.col);
            const networkId = parseInt(td.dataset.networkId);
            const network = networks.find(n => n.id === networkId);
            const menu = document.getElementById('symbolMenu');
            menu.innerHTML = '';

            if (row > 0 && col < network.cols - 1 && network.networkData[row][col].symbol !== 'occupied' && !network.networkData[row][col].bar) {
                const addBarItem = document.createElement('div');
                addBarItem.className = 'menu-item';
                addBarItem.textContent = 'Add Vertical Bar';
                addBarItem.onclick = () => {
                    addVerticalBar(networkId, row, col);
                    closeAllMenus();
                };
                menu.appendChild(addBarItem);
            }

            if (network.networkData[row][col].bar) {
                const deleteBarItem = document.createElement('div');
                deleteBarItem.className = 'menu-item';
                deleteBarItem.textContent = 'Delete Vertical Bar';
                deleteBarItem.onclick = () => {
                    deleteVerticalBar(networkId, row, col);
                    closeAllMenus();
                };
                menu.appendChild(deleteBarItem);
            }

            if (network.networkData[row][col].symbol !== "NOP" && network.networkData[row][col].symbol !== 'occupied') {
                const deleteItem = document.createElement('div');
                deleteItem.className = 'menu-item';
                deleteItem.textContent = 'Delete Symbol';
                deleteItem.onclick = () => {
                    placeSymbol(networkId, row, col, 'delete');
                    closeAllMenus();
                };
                menu.appendChild(deleteItem);
            }

            if (network.networkData[row][col].symbol === "NOP" || network.networkData[row][col].symbol === "CONN") {
                Object.keys(symbols).filter(name => name !== "NOP").forEach(name => {
                    const item = document.createElement('div');
                    item.className = 'menu-item';
                    item.textContent = name;
                    item.onclick = () => {
                        placeSymbolWithValues(networkId, row, col, name);
                        closeAllMenus();
                    };
                    menu.appendChild(item);
                });
            }

            const rect = td.getBoundingClientRect();
            menu.style.left = `${rect.left + window.scrollX}px`;
            menu.style.top = `${rect.bottom + window.scrollY}px`;
            menu.style.display = 'block';
            currentMenu = menu;
        }

        function showDataTypeMenu(event) {
            event.preventDefault();
            event.stopPropagation();
            closeAllMenus();
            const td = event.currentTarget;
            const row = parseInt(td.dataset.row);
            const col = parseInt(td.dataset.col);
            const networkId = parseInt(td.dataset.networkId);
            const network = networks.find(n => n.id === networkId);
            const menu = document.getElementById('dataTypeMenu');
            menu.innerHTML = '';

            if (network.networkData[row][col].symbol === "NOP" || network.networkData[row][col].symbol === 'occupied') return;

            const symbol = symbols[network.networkData[row][col].symbol];
            const dataEntries = symbol.dataEntries;
            const inputs = [];

            for (let i = 0; i < dataEntries.length; i++) {
                const entry = dataEntries[i];
                const valueDiv = document.createElement('div');
                valueDiv.className = 'value-entry';

                const label = document.createElement('span');
                label.className = 'value-label';
                label.textContent = entry.name + ':';
                valueDiv.appendChild(label);

                const pairDiv = document.createElement('div');
                pairDiv.className = 'value-pair';

                let typeSelect = null;
                if (entry.allowedTypes.length === 1) {
                    const typeText = document.createElement('span');
                    typeText.textContent = entry.allowedTypes[0];
                    pairDiv.appendChild(typeText);
                } else {
                    typeSelect = document.createElement('select');
                    entry.allowedTypes.forEach(type => {
                        const option = document.createElement('option');
                        option.value = type;
                        option.textContent = type;
                        if (type === (network.networkData[row][col].data[i]?.type || entry.allowedTypes[0])) option.selected = true;
                        typeSelect.appendChild(option);
                    });
                    pairDiv.appendChild(typeSelect);
                }

                const input = document.createElement('input');
                input.type = 'text';
                input.value = network.networkData[row][col].data[i]?.value || '0';
                pairDiv.appendChild(input);
                valueDiv.appendChild(pairDiv);
                menu.appendChild(valueDiv);

                inputs.push({
                    input: input,
                    typeSelect: typeSelect,
                    dataIndex: i
                });
            }

            const confirmButton = document.createElement('button');
            confirmButton.textContent = 'Confirm';
            confirmButton.onclick = () => {
                let allValid = true;
                const newData = [];
                inputs.forEach(({ input, typeSelect, dataIndex }) => {
                    const type = typeSelect ? typeSelect.value : dataEntries[dataIndex].allowedTypes[0];
                    const value = input.value;
                    if (!validateValue(type, value)) {
                        allValid = false;
                        input.style.border = '1px solid red';
                    } else {
                        input.style.border = '';
                        newData.push({
                            name: dataEntries[dataIndex].name,
                            type: type,
                            value: value
                        });
                    }
                });
                if (allValid) {
                    network.networkData[row][col].data = newData;
                    network.renderNetwork();
                    renderSymbolValues();
                    saveToHistory();
                    closeAllMenus();
                } else {
                    showToast('Some values are invalid. Please correct them.');
                }
            };
            menu.appendChild(confirmButton);

            const rect = td.getBoundingClientRect();
            menu.style.left = `${rect.left + window.scrollX}px`;
            menu.style.top = `${rect.bottom + window.scrollY}px`;
            menu.style.display = 'block';
            currentMenu = menu;
        }

        function autoCompleteRow(network, row) {
            const hasFunctionalSymbol = network.networkData[row].some(cell => cell.symbol !== "NOP" && cell.symbol !== "CONN");
            if (hasFunctionalSymbol) {
                for (let j = 0; j < network.cols; j++) {
                    if (network.networkData[row][j].symbol === "NOP") {
                        network.networkData[row][j].symbol = "CONN";
                        network.networkData[row][j].data = [];
                    }
                }
            }
        }

        function placeSymbolWithValues(networkId, row, col, symbolName) {
            const network = networks.find(n => n.id === networkId);
            const symbol = symbols[symbolName];
            if (row + symbol.cells > network.rows) {
                showToast("Not enough rows to place this symbol.");
                return;
            }
            let canPlace = true;
            for (let i = 0; i < symbol.cells && row + i < network.rows; i++) {
                if (network.networkData[row + i][col].symbol !== "NOP" && network.networkData[row + i][col].symbol !== "CONN") {
                    canPlace = false;
                    break;
                }
            }
            if (canPlace) {
                const hasBar = network.networkData[row][col].bar;
                for (let i = 0; i < symbol.cells && row + i < network.rows; i++) {
                    network.networkData[row + i][col].symbol = i === 0 ? symbolName : 'occupied';
                    network.networkData[row + i][col].bar = i === 0 ? hasBar : false;
                    if (i === 0) {
                        network.networkData[row + i][col].data = symbol.dataEntries.map(entry => ({
                            name: entry.name,
                            type: entry.allowedTypes[0],
                            value: '0'
                        }));
                    } else {
                        network.networkData[row + i][col].data = [];
                    }
                }

                if (symbol.cells === 1) {
                    autoCompleteRow(network, row);
                } else {
                    for (let i = 0; i < symbol.cells && row + i < network.rows; i++) {
                        const r = row + i;
                        const pin = symbol.pins[i];
                        if (pin.left) {
                            for (let j = 0; j < col; j++) {
                                if (network.networkData[r][j].symbol === "NOP") {
                                    network.networkData[r][j].symbol = "CONN";
                                    network.networkData[r][j].data = [];
                                }
                            }
                        } else {
                            let j = col - 1;
                            while (j >= 0) {
                                if (network.networkData[r][j].symbol === "CONN") {
                                    network.networkData[r][j].symbol = "NOP";
                                    network.networkData[r][j].data = [];
                                } else if (network.networkData[r][j].symbol !== "NOP") {
                                    break;
                                }
                                j--;
                            }
                        }
                        if (pin.right) {
                            for (let j = col + 1; j < network.cols; j++) {
                                if (network.networkData[r][j].symbol === "NOP") {
                                    network.networkData[r][j].symbol = "CONN";
                                    network.networkData[r][j].data = [];
                                }
                            }
                        }
                    }
                }

                network.renderNetwork();
                renderSymbolValues();
                saveToHistory();
            } else {
                showToast("Cannot place symbol: space is already occupied.");
            }
        }

        function placeSymbol(networkId, row, col, symbolName) {
            const network = networks.find(n => n.id === networkId);
            if (symbolName === 'delete') {
                if (network.networkData[row][col].symbol !== "NOP" && network.networkData[row][col].symbol !== 'occupied') {
                    const cells = symbols[network.networkData[row][col].symbol].cells;
                    for (let i = 0; i < cells && row + i < network.rows; i++) {
                        network.networkData[row + i][col].symbol = "NOP";
                        network.networkData[row + i][col].bar = i === 0 ? network.networkData[row][col].bar : false;
                        network.networkData[row + i][col].data = [];
                    }
                    network.renderNetwork();
                    renderSymbolValues();
                    saveToHistory();
                }
            }
        }

        function addVerticalBar(networkId, row, col) {
            const network = networks.find(n => n.id === networkId);
            if (row < 1) {
                showToast("Cannot place vertical bar in the top row.");
                return;
            }
            if (col >= network.cols - 1) {
                showToast("Cannot place vertical bar in the last column.");
                return;
            }
            if (network.networkData[row][col].symbol === 'occupied') {
                showToast("Cannot place vertical bar on an occupied cell.");
                return;
            }
            network.networkData[row][col].bar = true;
            network.renderNetwork();
            renderSymbolValues();
            saveToHistory();
        }

        function deleteVerticalBar(networkId, row, col) {
            const network = networks.find(n => n.id === networkId);
            network.networkData[row][col].bar = false;
            network.renderNetwork();
            renderSymbolValues();
            saveToHistory();
        }

        function saveNetworks() {
            if (wsStatus !== "disconnected") {
                const data = networks.map(n => ({
                    id: n.id,
                    rows: n.rows,
                    cols: n.cols,
                    networkData: n.networkData
                }));
                ws.send(JSON.stringify({ action: "save", data: data }));
                showToast("Saved to server.");
            } else {
                const data = networks.map(n => ({
                    id: n.id,
                    rows: n.rows,
                    cols: n.cols,
                    networkData: n.networkData
                }));
                const formattedData = JSON.stringify(data, null, 2);
                const blob = new Blob([formattedData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'ladder_networks.json';
                a.click();
                URL.revokeObjectURL(url);
            }
        }

        function validateNetworkData(networkData, rows, cols) {
            const validatedData = [];
            for (let i = 0; i < rows; i++) {
                const row = [];
                for (let j = 0; j < cols; j++) {
                    let cell = networkData[i]?.[j];
                    if (typeof cell !== 'object' || cell === null) {
                        cell = { symbol: "NOP", bar: false, data: [] };
                    }
                    if (typeof cell.symbol !== 'string' || !symbols[cell.symbol]) {
                        cell.symbol = "NOP";
                    }
                    cell.bar = !!cell.bar;
                    if (!Array.isArray(cell.data)) {
                        cell.data = [];
                    }
                    if (cell.symbol !== "NOP" && cell.symbol !== "occupied" && symbols[cell.symbol]) {
                        const symbolDef = symbols[cell.symbol];
                        const expectedDataEntries = symbolDef.dataEntries;
                        const newData = [];
                        expectedDataEntries.forEach(entry => {
                            const loadedEntry = cell.data.find(d => d.name === entry.name && typeof d.type === 'string' && typeof d.value === 'string');
                            if (loadedEntry && entry.allowedTypes.includes(loadedEntry.type)) {
                                newData.push({ name: entry.name, type: loadedEntry.type, value: loadedEntry.value });
                            } else {
                                newData.push({ name: entry.name, type: entry.allowedTypes[0], value: '0' });
                            }
                        });
                        cell.data = newData;
                    } else {
                        cell.data = [];
                    }
                    row.push(cell);
                }
                validatedData.push(row);
            }
            return validatedData;
        }

        function loadNetworks(event) {
            const file = event.target.files[0];
            if (!file) return;
            if (file.size > 10 * 1024 * 1024) {
                showToast('File is too large to process.');
                return;
            }
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                try {
                    const data = JSON.parse(text);
                    if (!Array.isArray(data)) {
                        throw new Error('Invalid network data format: not an array');
                    }
                    if (data.length > MAX_NETWORKS) {
                        showToast(`Only the first ${MAX_NETWORKS} networks will be loaded.`);
                        data = data.slice(0, MAX_NETWORKS);
                    }
                    networks = [];
                    document.getElementById('networks-container').innerHTML = '';
                    document.getElementById('symbolValues').innerHTML = '';
                    networkCounter = 0;
                    data.forEach(n => {
                        if (!Number.isInteger(n.rows) || n.rows < 1 || !Number.isInteger(n.cols) || n.cols < 1) {
                            throw new Error('Invalid network dimensions');
                        }
                        if (n.rows > MAX_ROWS || n.cols > MAX_COLS) {
                            throw new Error(`Network exceeds size limits: rows=${n.rows}, cols=${n.cols}`);
                        }
                        const network = new Network(n.rows, n.cols);
                        network.networkData = validateNetworkData(n.networkData, n.rows, n.cols);
                        networks.push(network);
                        network.renderNetwork();
                    });
                    networks.forEach((n, index) => {
                        n.id = index;
                    });
                    renderSymbolValues();
                    saveToHistory();
                } catch (error) {
                    showToast('Error parsing file: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        function initiateLoad() {
            if (wsStatus !== "disconnected") {
                ws.send(JSON.stringify({ action: "load" }));
                showToast("Loading from server...");
            } else {
                document.getElementById('loadFile').click();
            }
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.style.position = 'fixed';
            toast.style.bottom = '20px';
            toast.style.left = '50%';
            toast.style.transform = 'translateX(-50%)';
            toast.style.background = '#333';
            toast.style.color = 'white';
            toast.style.padding = '10px 20px';
            toast.style.borderRadius = '5px';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function saveToHistory() {
            const state = JSON.stringify(networks.map(n => ({
                id: n.id,
                rows: n.rows,
                cols: n.cols,
                networkData: n.networkData.map(row => row.map(cell => ({ ...cell })))
            })));
            if (historyIndex < history.length - 1) {
                history = history.slice(0, historyIndex + 1);
            }
            history.push(state);
            historyIndex++;
        }

        function undo() {
            if (historyIndex > 0) {
                historyIndex--;
                restoreFromHistory();
            }
        }

        function redo() {
            if (historyIndex < history.length - 1) {
                historyIndex++;
                restoreFromHistory();
            }
        }

        function restoreFromHistory() {
            const state = JSON.parse(history[historyIndex]);
            networks = [];
            document.getElementById('networks-container').innerHTML = '';
            document.getElementById('symbolValues').innerHTML = '';
            state.forEach(n => {
                const network = new Network(n.rows, n.cols, n.id);
                network.networkData = n.networkData;
                networks.push(network);
                network.renderNetwork();
            });
            if (networks.length > 0) {
                const maxId = Math.max(...networks.map(n => n.id));
                networkCounter = maxId + 1;
            } else {
                networkCounter = 0;
            }
            renderSymbolValues();
        }

        document.getElementById('symbolValues').addEventListener('click', function(event) {
            const row = event.target.closest('tr.symbol-row');
            if (row) {
                const cells = row.cells;
                const networkId = parseInt(cells[0].textContent);
                const rowIndex = parseInt(cells[1].textContent);
                const colIndex = parseInt(cells[2].textContent);
                const cell = document.querySelector(`#network-${networkId} td[data-row="${rowIndex}"][data-col="${colIndex}"]`);
                if (cell) {
                    if (cell.classList.contains('blinking')) {
                        cell.classList.remove('blinking');
                        row.classList.remove('blinking');
                    } else {
                        const previousBlinkingCell = document.querySelector('td.blinking');
                        if (previousBlinkingCell) {
                            previousBlinkingCell.classList.remove('blinking');
                        }
                        const previousBlinkingRow = document.querySelector('tr.blinking');
                        if (previousBlinkingRow) {
                            previousBlinkingRow.classList.remove('blinking');
                        }
                        cell.classList.add('blinking');
                        row.classList.add('blinking');
                    }
                }
            }
        });

        document.addEventListener('click', function(event) {
            if (!event.target.closest('#symbolValues')) {
                const blinkingCell = document.querySelector('td.blinking');
                if (blinkingCell) {
                    blinkingCell.classList.remove('blinking');
                }
                const blinkingRow = document.querySelector('tr.blinking');
                if (blinkingRow) {
                    blinkingRow.classList.remove('blinking');
                }
            }
        });

        document.addEventListener('click', function(e) {
            if (currentMenu && !currentMenu.contains(e.target)) {
                currentMenu.style.display = 'none';
                currentMenu = null;
            }
        });

        window.onload = function() {
            addNetwork();
        };

        const ws = new WebSocket("ws://localhost:8080");
        let wsStatus = "disconnected";

        function updateIndicator() {
            const indicator = document.getElementById('ws-indicator');
            if (wsStatus === "disconnected") {
                indicator.style.backgroundColor = "red";
            } else if (wsStatus === "connected_not_running") {
                indicator.style.backgroundColor = "yellow";
            } else if (wsStatus === "connected_running") {
                indicator.style.backgroundColor = "green";
            }
        }

        function setAllCellsDefault() {
            document.querySelectorAll('td.active').forEach(cell => cell.classList.remove('active'));
        }

        function applyCellStates(cellStates) {
            setAllCellsDefault();
            cellStates.forEach(cs => {
                if (cs.state === 1) {
                    const cell = document.querySelector(`#network-${cs.networkId} td[data-row="${cs.row}"][data-col="${cs.col}"]`);
                    if (cell) {
                        cell.classList.add('active');
                    }
                }
            });
        }

        ws.onopen = function() {
            wsStatus = "connected_not_running";
            updateIndicator();
        };

        ws.onmessage = function(event) {
            const data = JSON.parse(event.data);
            if (data.action === "load_response") {
                const loadedNetworks = data.data;
                networks = [];
                document.getElementById('networks-container').innerHTML = '';
                document.getElementById('symbolValues').innerHTML = '';
                networkCounter = 0;
                loadedNetworks.forEach(n => {
                    const network = new Network(n.rows, n.cols, n.id);
                    network.networkData = validateNetworkData(n.networkData, n.rows, n.cols);
                    networks.push(network);
                    network.renderNetwork();
                });
                networks.forEach((n, index) => {
                    n.id = index;
                });
                renderSymbolValues();
                saveToHistory();
                showToast("Loaded from server.");
            } else if (data.status) {
                if (data.status === "running") {
                    wsStatus = "connected_running";
                    updateIndicator();
                    if (data.cell_states) {
                        applyCellStates(data.cell_states);
                    }
                } else if (data.status === "not_running") {
                    wsStatus = "connected_not_running";
                    updateIndicator();
                    setAllCellsDefault();
                }
            }
        };

        ws.onclose = function() {
            wsStatus = "disconnected";
            updateIndicator();
            setAllCellsDefault();
        };

        ws.onerror = function() {
            wsStatus = "disconnected";
            updateIndicator();
            setAllCellsDefault();
        };
    </script>
</body>
</html>
